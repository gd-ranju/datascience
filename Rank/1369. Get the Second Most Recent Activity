WITH RankedUserActivity AS (
    -- Rank user activities based on the most recent endDate
    SELECT
        *,
        -- Count the total number of activities per username
        COUNT(*) OVER(PARTITION BY username) AS `count`,
        -- Assign a rank based on the latest endDate (most recent first)
        RANK() OVER(
            PARTITION BY username 
            ORDER BY endDate DESC
        ) AS `rank`
    FROM UserActivity
)

SELECT
    username,
    activity,
    startDate,
    endDate
FROM RankedUserActivity
-- Include users who have only one activity OR the second most recent activity for users with multiple activities
WHERE `count` = 1 OR `rank` = 2;
