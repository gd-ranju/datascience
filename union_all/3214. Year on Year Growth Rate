-- Common Table Expression (CTE) to calculate the current year's spend for each product
WITH
    CurrentYearSpend AS (
        SELECT product_id, YEAR(transaction_date) AS year, SUM(spend) AS curr_year_spend
        FROM user_transactions
        GROUP BY product_id, YEAR(transaction_date)
    ),
    SpendComparison AS (
        -- Join the current year's spend with the previous year's spend for each product
        SELECT t1.year, t1.product_id, t1.curr_year_spend, t2.curr_year_spend AS prev_year_spend
        FROM
            CurrentYearSpend t1
            LEFT JOIN CurrentYearSpend t2 ON t1.product_id = t2.product_id AND t1.year = t2.year + 1
    )
-- Final selection of all columns and calculation of the Year-over-Year (YoY) growth rate
SELECT
    *,
    ROUND((curr_year_spend - prev_year_spend) / prev_year_spend * 100, 2) AS yoy_rate
FROM SpendComparison
ORDER BY product_id, year;
